@page "/product/{id:int}"
@model ProductDetailModel
@{
    ViewData["Title"] = "Produktdetails";
}

<!-- Produktdetail Section -->
<div class="container product-detail-container">
    <div class="row">
        <!-- Produktbild -->
        <div class="col-lg-6 mb-4">
            <div class="product-image-detail">
                <div class="main-image">
                    <div class="image-placeholder d-flex align-items-center justify-content-center">
                        @if (!string.IsNullOrEmpty(Model.Product?.BildUrl))
                        {
                            <img src="@Model.Product.BildUrl" alt="@Model.Product.Name" class="img-fluid" style="max-width: 100%; max-height: 100%; object-fit: contain;" />
                        }
                        else if (!string.IsNullOrEmpty(Model.Product?.IconClass))
                        {
                            <i class="@Model.Product.IconClass" style="font-size: 6rem; color: var(--color-medium-gray);"></i>
                        }
                        else
                        {
                            <i class="bi bi-box" style="font-size: 6rem; color: var(--color-medium-gray);"></i>
                        }
                    </div>
                </div>
                <!-- Thumbnail Gallery - Nur anzeigen wenn Bild vorhanden -->
                @if (!string.IsNullOrEmpty(Model.Product?.BildUrl))
                {
                    <div class="image-gallery mt-3">
                        <div class="row g-2">
                            <div class="col-3">
                                <div class="thumbnail-image active" style="cursor: pointer;">
                                    <img src="@Model.Product.BildUrl" alt="@Model.Product.Name" class="img-fluid" style="max-width: 100%; max-height: 100%; object-fit: cover;" />
                                </div>
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <!-- Thumbnail Gallery mit Icons -->
                    <div class="image-gallery mt-3">
                        <div class="row g-2">
                            <div class="col-3">
                                <div class="thumbnail-image active">
                                    <i class="@(Model.Product?.IconClass ?? "bi-box")"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- Produktinformation -->
        <div class="col-lg-6">
            <div class="product-info">
                @if (Model.Product != null)
                {
                    <!-- Produkttitel -->
                    <div class="product-header mb-3">
                        <h1 class="product-title">@Model.Product.Name</h1>
                        <p class="product-sku text-muted">Artikelnummer: PROD-@Model.Product.Id</p>
                    </div>

                    <!-- Preis -->
                    <div class="product-price mb-4">
                        <div class="price-display">
                            <span class="current-price">€@Model.Product.Preis.ToString("N2")</span>
                        </div>
                        <p class="price-unit text-muted">@Model.Product.Einheit</p>
                    </div>

                    <!-- Verfügbarkeit -->
                    <div class="availability mb-4">
                        @if (Model.Product.IstVerfuegbar && Model.Product.Anzahl > 0)
                        {
                            <div class="stock-status in-stock">
                                <i class="bi bi-check-circle-fill"></i>
                                <span>Sofort verfügbar - @Model.Product.Anzahl Stück auf Lager</span>
                            </div>
                        }
                        else
                        {
                            <div class="stock-status out-of-stock">
                                <i class="bi bi-x-circle-fill"></i>
                                <span>Ausverkauft</span>
                            </div>
                        }
                    </div>

                    <!-- Kurzbeschreibung -->
                    <div class="product-summary mb-4">
                        <p>@Model.Product.Beschreibung</p>
                    </div>

                    <!-- Kaufbereich -->
                    @if (Model.Product.IstVerfuegbar && Model.Product.Anzahl > 0)
                    {
                        <form method="post" id="addToCartForm">
                            <div class="purchase-section">
                                <!-- Mengenauswahl -->
                                <div class="quantity-selector mb-3">
                                    <label for="quantity" class="form-label">Menge:</label>
                                    <div class="input-group quantity-input">
                                        <button class="btn btn-outline-secondary quantity-btn" type="button" id="decrease-qty">
                                            <i class="bi bi-dash"></i>
                                        </button>
                                        <input type="number" class="form-control text-center" id="quantity" name="quantity" 
                                               value="1" min="1" max="@Model.Product.Anzahl">
                                        <button class="btn btn-outline-secondary quantity-btn" type="button" id="increase-qty">
                                            <i class="bi bi-plus"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div class="action-buttons">
                                    <button type="button" class="btn btn-primary btn-lg w-100 mb-2 add-to-cart-btn">
                                        <i class="bi bi-cart-plus"></i>
                                        In den Warenkorb
                                    </button>
                                </div>
                            </div>
                        </form>
                    }
                }
            </div>
        </div>
    </div>

    <!-- Produktbeschreibung Tabs -->
    @if (Model.Product != null)
    {
        <div class="product-tabs mt-5">
            <ul class="nav nav-tabs" id="productTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="description-tab" data-bs-toggle="tab" data-bs-target="#description" type="button" role="tab">
                        Beschreibung
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="productTabContent">
                <div class="tab-pane fade show active" id="description" role="tabpanel">
                    <div class="tab-content-inner">
                        <h3>Produktbeschreibung</h3>
                        <p>@Model.Product.Beschreibung</p>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const addToCartBtn = document.querySelector('.add-to-cart-btn');
        const quantityInput = document.getElementById('quantity');
        const decreaseBtn = document.getElementById('decrease-qty');
        const increaseBtn = document.getElementById('increase-qty');
        
        // Quantity buttons
        if (decreaseBtn && quantityInput) {
            decreaseBtn.addEventListener('click', function() {
                let val = parseInt(quantityInput.value);
                if (val > 1) {
                    quantityInput.value = val - 1;
                }
            });
        }
        
        if (increaseBtn && quantityInput) {
            increaseBtn.addEventListener('click', function() {
                let val = parseInt(quantityInput.value);
                let max = parseInt(quantityInput.max);
                if (val < max) {
                    quantityInput.value = val + 1;
                }
            });
        }
        
        // Add to cart
        if (addToCartBtn) {
            addToCartBtn.addEventListener('click', function(e) {
                e.preventDefault();
                
                const quantity = quantityInput ? parseInt(quantityInput.value) || 1 : 1;
                const productId = @(Model.Product?.Id ?? 0);
                
                if (productId === 0) {
                    alert('Produktfehler');
                    return;
                }
                
                // Zeige Loading
                const originalHtml = addToCartBtn.innerHTML;
                addToCartBtn.disabled = true;
                addToCartBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Wird hinzugefügt...';
                
                // Build form data
                const formData = new FormData();
                formData.append('productId', productId);
                formData.append('quantity', quantity);
                
                fetch('/product/' + productId + '?handler=AddToCart', {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    },
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Erfolg anzeigen
                        addToCartBtn.innerHTML = '<i class="bi bi-check-circle"></i> Hinzugefügt!';
                        addToCartBtn.classList.add('btn-success');
                        addToCartBtn.classList.remove('btn-primary');
                        
                        // Update Cart Badge
                        const cartBadge = document.querySelector('.navbar .badge');
                        if (cartBadge) {
                            cartBadge.textContent = data.cartCount;
                            cartBadge.style.transform = 'scale(1.3)';
                            setTimeout(() => {
                                cartBadge.style.transform = 'scale(1)';
                            }, 200);
                        }
                        
                        // Zurück zum ursprünglichen Zustand nach 2 Sekunden
                        setTimeout(() => {
                            addToCartBtn.innerHTML = originalHtml;
                            addToCartBtn.classList.remove('btn-success');
                            addToCartBtn.classList.add('btn-primary');
                            addToCartBtn.disabled = false;
                        }, 2000);
                    } else {
                        alert(data.message || 'Fehler beim Hinzufügen');
                        addToCartBtn.innerHTML = originalHtml;
                        addToCartBtn.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Ein Fehler ist aufgetreten: ' + error.message);
                    addToCartBtn.innerHTML = originalHtml;
                    addToCartBtn.disabled = false;
                });
            });
        }
    });
</script>
}